name: Build and Package C30Auto-login

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    # 仅当提交信息或 PR 标题包含 "开始打包" 时运行
    if: "contains(github.event.head_commit.message, '开始打包') || contains(github.event.pull_request.title, '开始打包')"
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      # 改为 --onedir (默认模式)，不再打包成单文件
      # --contents-directory "lib": 将所有 DLL 和依赖放入 lib 子文件夹，保持根目录清爽
      run: |
        pyinstaller --noconsole --onedir --clean --noupx --contents-directory "lib" --hidden-import sentry_sdk --hidden-import tomli --name "C30Auto-login" main.py

    - name: Prepare Release Artifacts
      # 创建发布文件夹
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release
        
        # 1. 核心程序：将 dist/C30Auto-login 文件夹下的所有内容（exe + 依赖库）复制到 release 根目录
        Copy-Item -Path "dist\C30Auto-login\*" -Destination release\ -Recurse

        # 2. 文档与配置：复制到 release 根目录，与 exe 同级
        Copy-Item README.md -Destination release\
        Copy-Item LICENSE -Destination release\
        Copy-Item TEMPLATE_GUIDE.md -Destination release\
        
        # 3. 资源文件：复制 resources 到 release 根目录
        Copy-Item -Path resources -Destination release\ -Recurse
        
        # 4. 配置文件
        if (Test-Path config.toml) { Copy-Item config.toml -Destination release\ }

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: C30Auto-login-Windows
        path: release/

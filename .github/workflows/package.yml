name: Build and Package C30Auto-login

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    # 仅当提交信息或 PR 标题包含 "开始打包" 时运行
    if: "contains(github.event.head_commit.message, '开始打包') || contains(github.event.pull_request.title, '开始打包')"
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      # --noupx: 关键参数！禁止压缩 DLL，解决 "Failed to extract opengl32sw.dll" 报错
      # --hidden-import: 显式声明动态加载的库
      # 移除 --collect-all 以减小体积，PyInstaller 默认分析通常足够
      run: |
        pyinstaller --noconsole --onefile --clean --noupx --hidden-import sentry_sdk --hidden-import tomli --name "C30Auto-login" main.py

    - name: Prepare Release Artifacts
      # 创建发布文件夹，包含 exe 和默认配置、说明文档
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item dist\C30Auto-login.exe -Destination release\
        Copy-Item README.md -Destination release\
        Copy-Item LICENSE -Destination release\
        Copy-Item TEMPLATE_GUIDE.md -Destination release\
        # 完整复制 resources 目录及其内容（包含模板文件与说明文档）
        Copy-Item -Path resources -Destination release\ -Recurse
        # 复制默认配置模板（如果存在）
        if (Test-Path config.toml) { Copy-Item config.toml -Destination release\ }

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: C30Auto-login-Windows
        path: release/
